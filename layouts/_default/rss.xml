# Patch #RSS-018 – Datei: layouts/_default/rss.xml
# Typ: Patch
# Ursache: Hugo rendert $rss intern als Text, bevor safeHTML greift → Namespace verliert Präfix „xmlns:“
# Lösung: $rss am Ende in (safeHTML) casten, statt Pipe nach Output.



{{- $rss := printf "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" -}}
{{- $rss = printf "%s<rss version=\"2.0\"\n  xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\n  xmlns:content=\"http://purl.org/rss/1.0/modules/content/\"\n  xmlns:atom=\"http://www.w3.org/2005/Atom\">\n\n" $rss -}}
{{- $rss = printf "%s  <channel>\n" $rss -}}
{{- $rss = printf "%s    <title>%s</title>\n" $rss (.Site.Title | html) -}}
{{- $rss = printf "%s    <link>%s</link>\n" $rss .Site.BaseURL -}}
{{- $rss = printf "%s    <description>%s</description>\n" $rss (.Site.Params.description | html) -}}
{{- $rss = printf "%s    <language>%s</language>\n" $rss (.Site.LanguageCode | default "de-de") -}}
{{- $rss = printf "%s    <generator>Hugo %s</generator>\n" $rss hugo.Version -}}
{{- $rss = printf "%s    <lastBuildDate>%s</lastBuildDate>\n" $rss (now.Format "Mon, 02 Jan 2006 15:04:05 -0700") -}}
{{- $rss = printf "%s    <atom:link href=\"%sindex.xml\" rel=\"self\" type=\"application/rss+xml\"/>\n\n" $rss .Site.BaseURL -}}

{{- $pages := where .Site.RegularPages "Type" "in" site.Params.mainSections -}}
{{- range first 20 (sort $pages "Date" "desc") }}
  {{- $rss = printf "%s    <item>\n" $rss -}}
  {{- $rss = printf "%s      <title>%s</title>\n" $rss (.Title | htmlEscape) -}}
  {{- $rss = printf "%s      <link>%s</link>\n" $rss .Permalink -}}
  {{- $rss = printf "%s      <guid>%s</guid>\n" $rss .Permalink -}}
  {{- $rss = printf "%s      <pubDate>%s</pubDate>\n" $rss (.Date.Format "Mon, 02 Jan 2006 15:04:05 -0700") -}}

  {{- $desc := "" -}}
  {{- if .Params.summary -}}
    {{- $desc = .Params.summary -}}
  {{- else if .Summary -}}
    {{- $desc = .Summary -}}
  {{- else -}}
    {{- $desc = .Plain | truncate 300 -}}
  {{- end -}}

  {{- $rss = printf "%s      <description><![CDATA[%s]]></description>\n" $rss $desc -}}
  {{- $rss = printf "%s    </item>\n" $rss -}}
{{- end }}

{{- $rss = printf "%s  </channel>\n</rss>\n" $rss -}}
{{- safeHTML $rss -}}